name: grow_phase8d_residue
description: Propose residue beats where path-specific prose should differ at convergence points

system: |
  You are identifying passages near convergence points where the narrative
  should acknowledge which path the player took. These are called "residue
  beats" -- moments where the prose should be different depending on the
  player's earlier choices.

  ## What is a Residue Beat?
  When two paths converge (merge back together), the first shared passage
  is a natural place to acknowledge what happened on the path the player
  chose. For example:
  - After a fight vs. negotiation choice, the shared passage might mention
    bruises (fight) or a new alliance (negotiation)
  - After a risky shortcut vs. safe route, the shared passage might note
    exhaustion (shortcut) or supplies running low (safe route, took longer)

  Each residue beat produces one variant per path, gated by the state flag
  that tracks which path was taken.

  ## Convergence Points and Available State Flags
  {convergence_context}

  ## Passage Summaries
  {passage_context}

  ## Rules
  1. Only propose residue beats for the passages listed above
  2. Each proposal targets ONE passage and ONE dilemma
  3. Each variant is gated by exactly ONE state flag from the available list
  4. The hint field tells the prose writer HOW to differentiate this variant
     (10-200 characters, specific and concrete)
  5. Maximum {max_proposals} proposals total
  6. Focus on the MOST narratively impactful convergence points first

  ## Hint Quality
  GOOD hints (specific, actionable):
  - "mention the scar from the fistfight"
  - "reference the fragile truce with the guards"
  - "describe lingering guilt over the betrayal"

  BAD hints (vague, generic):
  - "acknowledge the player's choice"
  - "reflect on what happened"
  - "show consequences"

  ## Valid IDs
  Valid passage_ids: {valid_passage_ids}
  Valid state_flag_ids (for variant gating): {valid_state_flag_ids}
  Valid dilemma_ids: {valid_dilemma_ids}

  ## Output Format
  Return a JSON object with a "proposals" array. Each proposal has:
  - passage_id: passage to split into variants
  - dilemma_id: dilemma whose paths are converging at this point
  - rationale: why this passage needs path-specific variants (1 sentence)
  - variants: array of objects, each with:
    - state_flag_id: the state flag that gates this variant
    - hint: specific prose guidance (10-200 chars)

  If no passages warrant residue variants, return an empty proposals array.

user: |
  Review the convergence points above and propose residue beats where the
  prose should differ based on the player's path.

  Focus on the strongest candidates first -- where the player's choice
  would most naturally be reflected in the shared passage.

  REMINDER: Use ONLY IDs from the Valid IDs section.
  Maximum {max_proposals} proposals.
  Return ONLY a valid JSON object.

components: []
